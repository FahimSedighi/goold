@model PriceViewModel
@{
    ViewData["Title"] = "داشبورد مالی";
}

<div class="dashboard-container">
    <!-- Top Bar with Login Section -->
    <div class="dashboard-topbar">
        <div class="dashboard-header">
            <h1 class="dashboard-title">
                <i class="bi bi-graph-up-arrow"></i>
                داشبورد مالی
            </h1>
        </div>
        
        <!-- Login Section -->
        <div class="login-section">
            <button class="login-toggle-btn" id="loginToggleBtn">
                <i class="bi bi-person-circle"></i>
                <span>ورود</span>
            </button>
            
            <!-- Login Dropdown -->
            <div class="login-dropdown" id="loginDropdown">
                <div class="login-dropdown-header">
                    <h3>ورود به حساب کاربری</h3>
                    <button class="close-login" id="closeLogin">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                
                <form id="loginForm" class="login-form-inline">
                    @Html.AntiForgeryToken()
                    
                    <div id="loginError" class="login-error-message" style="display: none;"></div>
                    
                    <div class="form-group-inline">
                        <label for="EmailOrUsername">
                            <i class="bi bi-person-fill"></i>
                            ایمیل یا نام کاربری
                        </label>
                        <input id="EmailOrUsername" 
                               name="EmailOrUsername"
                               type="text" 
                               class="form-input-inline" 
                               placeholder="ایمیل یا نام کاربری"
                               autocomplete="username"
                               required />
                        <span class="validation-error-inline" id="emailError"></span>
                    </div>

                    <div class="form-group-inline">
                        <label for="Password">
                            <i class="bi bi-lock-fill"></i>
                            رمز عبور
                        </label>
                        <div class="password-input-wrapper">
                            <input id="Password" 
                                   name="Password"
                                   type="password" 
                                   class="form-input-inline" 
                                   placeholder="رمز عبور"
                                   autocomplete="current-password"
                                   required />
                            <button type="button" class="password-toggle-inline" id="inlinePasswordToggle">
                                <i class="bi bi-eye" id="inlinePasswordIcon"></i>
                            </button>
                        </div>
                        <span class="validation-error-inline" id="passwordError"></span>
                    </div>

                    <div class="form-options-inline">
                        <label class="checkbox-label-inline">
                            <input id="RememberMe" name="RememberMe" type="checkbox" class="checkbox-input-inline" />
                            <span class="checkbox-custom-inline"></span>
                            <span class="checkbox-text-inline">مرا به خاطر بسپار</span>
                        </label>
                        <a href="#" class="forgot-password-link-inline">فراموشی رمز عبور</a>
                    </div>

                    <button type="submit" class="login-button-inline" id="loginSubmitBtn">
                        <span>ورود</span>
                        <i class="bi bi-arrow-left"></i>
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Theme Toggle -->
        <button class="theme-toggle" id="themeToggle" aria-label="تغییر تم">
            <i class="bi bi-moon-fill" id="themeIcon"></i>
        </button>
    </div>

    <!-- Price Cards Section -->
    <div class="price-cards-grid">
        <!-- Gold 18k Card -->
        <div class="price-card gold-card">
            <div class="card-header-section">
                <div class="card-icon gold-icon">
                    <i class="bi bi-gem"></i>
                </div>
                <div class="card-title-section">
                    <h3 class="card-title">طلای 18 عیار</h3>
                    <span class="card-subtitle">هر گرم</span>
                </div>
            </div>
            <div class="card-price-section">
                <div class="price-value">@Model.GoldPrice.Price.ToString("N0")</div>
                <div class="price-unit">تومان</div>
            </div>
            <div class="card-change-section">
                <div class="change-indicator @(Model.GoldPrice.ChangePercent >= 0 ? "positive" : "negative")">
                    <i class="bi @(Model.GoldPrice.ChangePercent >= 0 ? "bi-arrow-up" : "bi-arrow-down")"></i>
                    <span class="change-value">@Math.Abs(Model.GoldPrice.ChangePercent).ToString("F2")%</span>
                </div>
                <div class="change-amount">@(Model.GoldPrice.Change >= 0 ? "+" : "")@Model.GoldPrice.Change.ToString("N0") تومان</div>
            </div>
            <div class="card-footer">
                <small class="update-time">
                    <i class="bi bi-clock"></i>
                    @Model.GoldPrice.LastUpdate.ToString("HH:mm:ss")
                </small>
            </div>
        </div>

        <!-- Coin Card -->
        <div class="price-card coin-card">
            <div class="card-header-section">
                <div class="card-icon coin-icon">
                    <i class="bi bi-coin"></i>
                </div>
                <div class="card-title-section">
                    <h3 class="card-title">سکه</h3>
                    <span class="card-subtitle">هر عدد</span>
                </div>
            </div>
            <div class="card-price-section">
                <div class="price-value">@Model.CoinPrice.Price.ToString("N0")</div>
                <div class="price-unit">تومان</div>
            </div>
            <div class="card-change-section">
                <div class="change-indicator @(Model.CoinPrice.ChangePercent >= 0 ? "positive" : "negative")">
                    <i class="bi @(Model.CoinPrice.ChangePercent >= 0 ? "bi-arrow-up" : "bi-arrow-down")"></i>
                    <span class="change-value">@Math.Abs(Model.CoinPrice.ChangePercent).ToString("F2")%</span>
                </div>
                <div class="change-amount">@(Model.CoinPrice.Change >= 0 ? "+" : "")@Model.CoinPrice.Change.ToString("N0") تومان</div>
            </div>
            <div class="card-footer">
                <small class="update-time">
                    <i class="bi bi-clock"></i>
                    @Model.CoinPrice.LastUpdate.ToString("HH:mm:ss")
                </small>
            </div>
        </div>

        <!-- US Dollar Card -->
        <div class="price-card dollar-card">
            <div class="card-header-section">
                <div class="card-icon dollar-icon">
                    <i class="bi bi-currency-dollar"></i>
                </div>
                <div class="card-title-section">
                    <h3 class="card-title">دلار آمریکا</h3>
                    <span class="card-subtitle">هر واحد</span>
                </div>
            </div>
            <div class="card-price-section">
                <div class="price-value">@Model.DollarPrice.Price.ToString("N0")</div>
                <div class="price-unit">تومان</div>
            </div>
            <div class="card-change-section">
                <div class="change-indicator @(Model.DollarPrice.ChangePercent >= 0 ? "positive" : "negative")">
                    <i class="bi @(Model.DollarPrice.ChangePercent >= 0 ? "bi-arrow-up" : "bi-arrow-down")"></i>
                    <span class="change-value">@Math.Abs(Model.DollarPrice.ChangePercent).ToString("F2")%</span>
                </div>
                <div class="change-amount">@(Model.DollarPrice.Change >= 0 ? "+" : "")@Model.DollarPrice.Change.ToString("N0") تومان</div>
            </div>
            <div class="card-footer">
                <small class="update-time">
                    <i class="bi bi-clock"></i>
                    @Model.DollarPrice.LastUpdate.ToString("HH:mm:ss")
                </small>
            </div>
        </div>
    </div>

    <!-- Chart Section -->
    <div class="chart-section">
        <div class="chart-card">
            <div class="chart-header">
                <h2 class="chart-title">
                    <i class="bi bi-graph-up"></i>
                    روند قیمت‌ها
                </h2>
                <div class="chart-legend">
                    <div class="legend-item">
                        <span class="legend-color gold-legend"></span>
                        <span>طلای 18 عیار</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color coin-legend"></span>
                        <span>سکه</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color dollar-legend"></span>
                        <span>دلار</span>
                    </div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation-unobtrusive@3.2.12/dist/jquery.validate.unobtrusive.min.js"></script>
    <script>
        // Dark Mode Toggle
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const body = document.body;

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
            body.classList.add('dark-mode');
            themeIcon.classList.remove('bi-moon-fill');
            themeIcon.classList.add('bi-sun-fill');
        }

        themeToggle.addEventListener('click', () => {
            body.classList.toggle('dark-mode');
            const isDark = body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            themeIcon.classList.toggle('bi-moon-fill');
            themeIcon.classList.toggle('bi-sun-fill');
        });

        // Login Dropdown Toggle
        const loginToggleBtn = document.getElementById('loginToggleBtn');
        const loginDropdown = document.getElementById('loginDropdown');
        const closeLogin = document.getElementById('closeLogin');

        if (loginToggleBtn && loginDropdown) {
            loginToggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                loginDropdown.classList.toggle('show');
            });

            if (closeLogin) {
                closeLogin.addEventListener('click', () => {
                    loginDropdown.classList.remove('show');
                });
            }

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!loginDropdown.contains(e.target) && !loginToggleBtn.contains(e.target)) {
                    loginDropdown.classList.remove('show');
                }
            });
        }

        // Password Toggle
        const inlinePasswordToggle = document.getElementById('inlinePasswordToggle');
        const inlinePassword = document.getElementById('Password');
        const inlinePasswordIcon = document.getElementById('inlinePasswordIcon');

        if (inlinePasswordToggle && inlinePassword) {
            inlinePasswordToggle.addEventListener('click', () => {
                const type = inlinePassword.getAttribute('type') === 'password' ? 'text' : 'password';
                inlinePassword.setAttribute('type', type);
                
                if (inlinePasswordIcon) {
                    inlinePasswordIcon.classList.toggle('bi-eye');
                    inlinePasswordIcon.classList.toggle('bi-eye-slash');
                }
            });
        }

        // Login Form Submission
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const loginSubmitBtn = document.getElementById('loginSubmitBtn');

        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Hide previous errors
                if (loginError) loginError.style.display = 'none';
                const emailError = document.getElementById('emailError');
                const passwordError = document.getElementById('passwordError');
                if (emailError) emailError.textContent = '';
                if (passwordError) passwordError.textContent = '';
                
                // Disable button
                if (loginSubmitBtn) {
                    loginSubmitBtn.disabled = true;
                    loginSubmitBtn.classList.add('loading');
                }

                const formData = {
                    EmailOrUsername: document.getElementById('EmailOrUsername').value,
                    Password: document.getElementById('Password').value,
                    RememberMe: document.getElementById('RememberMe').checked
                };

                try {
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                        },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Success - redirect to dashboard
                        window.location.href = '/Dashboard';
                    } else {
                        // Show error
                        if (loginError) {
                            loginError.textContent = result.message || 'خطا در ورود';
                            loginError.style.display = 'block';
                        }
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    if (loginError) {
                        loginError.textContent = 'خطا در ارتباط با سرور';
                        loginError.style.display = 'block';
                    }
                } finally {
                    if (loginSubmitBtn) {
                        loginSubmitBtn.disabled = false;
                        loginSubmitBtn.classList.remove('loading');
                    }
                }
            });
        }

        // Chart Data
        const goldPrice = @Model.GoldPrice.Price;
        const coinPrice = @Model.CoinPrice.Price;
        const dollarPrice = @Model.DollarPrice.Price;

        // Generate sample data for the last 24 hours
        const labels = [];
        const goldData = [];
        const coinData = [];
        const dollarData = [];

        for (let i = 23; i >= 0; i--) {
            const date = new Date();
            date.setHours(date.getHours() - i);
            labels.push(date.toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' }));
            
            // Simulate price variations
            const variation = (Math.random() - 0.5) * 0.05; // ±2.5% variation
            goldData.push(goldPrice * (1 + variation));
            coinData.push(coinPrice * (1 + variation));
            dollarData.push(dollarPrice * (1 + variation));
        }

        // Chart Configuration
        const ctx = document.getElementById('priceChart').getContext('2d');
        const priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'طلای 18 عیار',
                        data: goldData,
                        borderColor: '#FFD700',
                        backgroundColor: 'rgba(255, 215, 0, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 5
                    },
                    {
                        label: 'سکه',
                        data: coinData,
                        borderColor: '#FFA500',
                        backgroundColor: 'rgba(255, 165, 0, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 5
                    },
                    {
                        label: 'دلار',
                        data: dollarData,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 5
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13
                        },
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toLocaleString('fa-IR') + ' تومان';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            maxRotation: 0,
                            minRotation: 0,
                            font: {
                                size: 11
                            }
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('fa-IR');
                            },
                            font: {
                                size: 11
                            }
                        }
                    }
                }
            }
        });

        // Update chart theme on mode change
        themeToggle.addEventListener('click', () => {
            setTimeout(() => {
                priceChart.update();
            }, 100);
        });

        // Auto refresh every 30 seconds
        setInterval(function() {
            location.reload();
        }, 30000);
    </script>
}
